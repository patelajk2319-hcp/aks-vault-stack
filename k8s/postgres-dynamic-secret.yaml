---
# =============================================================================
# VaultDynamicSecret - PostgreSQL Dynamic Credentials
# Syncs dynamic database credentials from Vault to Kubernetes secrets
# =============================================================================
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultDynamicSecret
metadata:
  name: postgres-dynamic-creds
  namespace: vault
spec:
  # Vault mount point for database secrets engine
  mount: database

  # Path to request credentials (database/creds/<role-name>)
  path: creds/postgres-role

  # Kubernetes secret to create/update
  destination:
    name: postgres-dynamic-creds
    create: true

  # Vault authentication configuration
  vaultAuthRef: vault-auth

  # Refresh credentials before expiry (5 minutes TTL, refresh at 4 minutes)
  refreshAfter: 240s
---
# =============================================================================
# VaultAuth - JWT Authentication Configuration
# Configures how VSO authenticates to Vault using service account JWT tokens
# =============================================================================
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: vault-auth
  namespace: vault
spec:
  # Vault server address (via port-forward or service)
  vaultConnectionRef: vault-connection

  # JWT authentication method
  method: jwt
  mount: jwt

  # JWT role for VSO
  jwt:
    role: vso
    serviceAccount: vault-secrets-operator-controller-manager
    audiences:
      - https://kubernetes.default.svc.cluster.local
---
# =============================================================================
# VaultConnection - Vault Server Connection
# Configures connection details for Vault server
# =============================================================================
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultConnection
metadata:
  name: vault-connection
  namespace: vault
spec:
  # Vault server address
  address: http://vault.vault.svc.cluster.local:8200

  # Skip TLS verification for development (in-cluster connection)
  skipTLSVerify: true
